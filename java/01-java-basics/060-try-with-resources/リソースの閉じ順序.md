# リソースの閉じ順序

# Q,

try-with-resourcesにて宣言した時と逆の順序で自動で閉じていきますが、なぜでしょうか？

とても鋭い質問です。

`try-with-resources` でリソースが **宣言した逆の順序で自動的に閉じられる理由** は、**リソースの依存関係と安全なクリーンアップのため**です。

---

## ✅ 結論

> リソースは「最後に開いたものから順に」クローズすることで、依存関係を壊さずに安全に解放できるため、宣言と逆順で close() が呼ばれます。
> 

---

## 🔹 具体例で理解する

```java
try (
    FileInputStream fis = new FileInputStream("input.txt");
    InputStreamReader isr = new InputStreamReader(fis);
    BufferedReader br = new BufferedReader(isr)
) {
    // 読み取り処理
}
```

### リソースの依存構造

```java
BufferedReader → InputStreamReader → FileInputStream
      ↑                 ↑                    ↑
   最後に開いた       ２番目              最初に開いた
```

### 自動クローズの順序（逆順）

```java
br.close();   // BufferedReader が最初に閉じられる
isr.close();  // 次に InputStreamReader
fis.close();  // 最後に FileInputStream
```

---

## 🔸 なぜ逆順で閉じるのか？

### 🔹 リソースの依存関係を守るため

- 上位のリソース（例：BufferedReader）は、下位のリソース（例：InputStream）を使って動作します。
- **先に下位リソースを閉じてしまうと、上位リソースがまだ使っている最中にエラーが発生する可能性があります。**

### 🔹 例：間違った順序で閉じた場合の問題

```java
fis.close(); // 先に基礎リソースを閉じる
br.readLine(); // → IOException: Stream closed
```

- 上位リソースがアクセス不能になるリスク
- **例外が発生したり、リソースリークになったりする**

---

## 🔸 `try-with-resources` における仕様（Java言語仕様）

Javaの仕様として、`try-with-resources` 文におけるリソースのクローズ順序は **厳密に「逆順」と決まっています**。

> JLS（Java Language Specification）14.20.3 に明記：
> 
> - リソースは、**それらが `try` 文に現れた順序の逆に、`close()` を呼び出す。**
> - 各 `close()` 呼び出しで例外が発生しても、**他のリソースの `close()` は実行される。**

---

## 🔹 まとめ表

| 観点 | 内容 |
| --- | --- |
| クローズ順序 | 宣言した**逆順**で `close()` が呼ばれる |
| 理由① | **依存関係を守る**ため（上位が下位に依存している） |
| 理由② | **安全なクリーンアップ**を保証するため |
| Java仕様 | JLS 14.20.3 にて **逆順での `close()` 呼び出し**が定義されている |

---

## ✅ 補足：複数リソースでの例

```java
try (
    MyResourceA a = new MyResourceA();
    MyResourceB b = new MyResourceB()
) {
    // ...
}
```

終了時の順序：

```java
b.close(); // ← 最後に開いたものが最初に閉じられる
a.close();
```

---

必要であれば、「`close()` で例外が発生したときのサプレッション（`SuppressedException`）の仕組み」なども解説できます！