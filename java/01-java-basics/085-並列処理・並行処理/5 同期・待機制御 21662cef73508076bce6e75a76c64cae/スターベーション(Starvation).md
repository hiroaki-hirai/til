# スターベーション(Starvation)

# Q,

スターベーションについて解説してください。

もちろんです。`スターベーション（Starvation）` は、**スレッドが永久にリソースを取得できず、処理が進まない状態**を指します。**デッドロックやライブロックと並ぶ“スレッド同期の落とし穴”の1つ**です。

---

## 🔷 スターベーション（Starvation）とは？

### 📌 定義

> 他のスレッドにリソースを奪われ続けることで、あるスレッドの処理がずっと実行されない状態
> 
- スレッド自体は動作可能だが…
- **スケジューラやロックのポリシーの影響**で「待機し続ける」
- 結果として「実行機会が与えられない」状態になる

---

## 🔶 具体例

### 例：低優先度スレッドが「飢餓状態」に陥る

```java
public class StarvationExample {
    private final Object lock = new Object();

    public void runHighPriority() {
        synchronized (lock) {
            System.out.println(Thread.currentThread().getName() + " running (high)");
            try { Thread.sleep(100); } catch (InterruptedException e) {}
        }
    }

    public void runLowPriority() {
        synchronized (lock) {
            System.out.println(Thread.currentThread().getName() + " running (low)");
        }
    }
}
```

- 複数の高優先度スレッドが `lock` を占有し続けると…
- **低優先度スレッドはいつまでたっても実行できない**

---

## ✅ 発生原因まとめ

| 原因 | 内容 |
| --- | --- |
| 優先度の偏り | 高優先度スレッドが優先的にスケジューリングされ、低優先度スレッドが実行されない |
| ロックの偏り | 特定のスレッドがロックを取り続ける設計になっており、他スレッドが入れない |
| 不公平な同期制御 | 例：`ReentrantLock` の非フェアモード（後から来たスレッドが割り込んで取得） |
| 無限リトライ処理 | 自分の順番が回ってこないのにリトライし続けるような設計 |

---

## 🔍 デッドロック・ライブロックとの比較

| 分類 | 実行状態 | 原因 | 説明 |
| --- | --- | --- | --- |
| 🟥 デッドロック | 停止 | 循環待機 | お互いがロックを持ったまま進まない |
| 🟧 ライブロック | 活動しているが進まない | 譲り合いすぎ | 状態変化を繰り返すが完了しない |
| 🟨 スターベーション | 実行されない | 他スレッドに阻まれる | 常に待たされて出番がこない |

---

## ✅ 対策方法

| 対策 | 説明 |
| --- | --- |
| **スレッド優先度を使わない** | OSやJVMのスケジューリングが変わるので、不安定になる可能性がある |
| **公平なロックを使用する** | `ReentrantLock fair = new ReentrantLock(true);` ← 先着順ロック取得 |
| **スレッドキューの制御** | スレッドプールやリクエストキューで先着順処理など |
| **タイムアウト付きロック** | 取得できない場合は別のアクションへ分岐するなど |

---

## 💡 イメージ比喩

> レストランで行列に並んでいるのに、後から来た常連客ばかり優先されて、あなたの番がいつまでも来ない状態
> 

→ 並んではいる、食べる意思もある、でも一口も食べられない。これがスターベーションです。

---

## 🔚 まとめ

| 項目 | 内容 |
| --- | --- |
| 状態 | スレッドは生きているが、処理のチャンスが永遠に来ない |
| 原因 | リソース競合・優先度・非フェアな設計 |
| 解決策 | 公平性の導入、優先度に依存しない設計、フェアロック、タイムアウト制御 |

---

ご希望であれば、「デッドロック」「ライブロック」「スターベーション」の**比較早見表＋コード例つきまとめ**も作成可能です！