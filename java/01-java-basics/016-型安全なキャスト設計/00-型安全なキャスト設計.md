# 型安全なキャスト設計

---

# ✅ 【テーマ】

**キャスト＋instanceofを正しく駆使して、安全に型変換する特訓問題！**

---

# 🎯 【背景（なぜこれが重要？）】

- Javaでは**スーパークラス型に代入したオブジェクト**を
- *サブクラス型に戻したい（ダウンキャストしたい）**ことがよくある
- しかし、**実体型を正しく把握しないとClassCastExceptionが発生する**

👉 だから、安全にやるためには

**「instanceofを使った事前チェック」＋「キャスト」**が必須！

---

# 📚 【基本型】

```java
if (obj instanceof String) {
    String s = (String) obj;
    // ここから安全にStringメソッドが使える
}
```

---

# ✍️ 【ここから特訓問題スタート！】

---

## 【問題1】

次のコードで、安全に"文字列の長さ"を出力してください。

```java
Object obj = "Hello";

【ここにコードを書く】

if (obj instanceof String) {
    String s = (String) obj;
    System.out.println(s.length());
}
```

---

🔵 【解説】

- `instanceof String` で、**実体型がStringか**事前チェック
- OKなら**キャスト**して安全にStringメソッド（length()）を使う
- **失敗するリスクゼロ！**

---

## 【問題2】

次のコードで、安全に"リストのサイズ"を出力してください。

```java
Object obj = new ArrayList<>(List.of(1, 2, 3));

【ここにコードを書く】

if (obj instanceof List) {
    List<?> list = (List<?>) obj;
    System.out.println(list.size());
}
```

---

🔵 【解説】

- `instanceof List` で、リストかどうかチェック
- 安全にキャストするときは、**ジェネリクスはワイルドカード（<?>）**にしておくのが実務的
- size()はListインターフェースのメソッドなので、問題なく呼べる！

---

## 【問題3】

次のコードで、安全に"数値の2倍"を出力してください。

```java
Object obj = Integer.valueOf(42);

【ここにコードを書く】

if (obj instanceof Integer) {
    Integer num = (Integer) obj;
    System.out.println(num * 2);
}
```

🔵 【解説】

- `instanceof Integer` で数値か判定
- キャストしてから普通に計算
- **オートボクシング・アンボクシング**（intとIntegerの変換）もJavaが自動でやってくれる！

---

## 【問題4】

次のコードで、安全に"エラーにならないように出力"してください。
（objは実体がIntegerなのにStringにキャストしようとしている）

```java
Object obj = Integer.valueOf(10);

【ここにコードを書く】

if (obj instanceof String) {
    String s = (String) obj;
    System.out.println(s);
} else {
    System.out.println("型が違います");
}
```

---

🔵 【解説】

- **instanceofを使わずにキャストすると、ClassCastExceptionの危険あり！**
- きちんと型を確認してからキャストする
- elseで「型が違います」と安全に処理する
- これが**型安全なダウンキャスト**の基本！

---

## 【問題5（応用問題）】

次のコードで、objの中身に応じて

- Stringなら「文字列長」
- Listなら「要素数」
- Integerなら「2倍の値」
を出力してください。

```java
Object obj = getObject(); // 何が返るかはランダム

【ここにコードを書く】

if (obj instanceof String) {
    String s = (String) obj;
    System.out.println("文字列長: " + s.length());
} else if (obj instanceof List) {
    List<?> list = (List<?>) obj;
    System.out.println("要素数: " + list.size());
} else if (obj instanceof Integer) {
    Integer num = (Integer) obj;
    System.out.println("2倍の値: " + (num * 2));
} else {
    System.out.println("不明な型です");
}
```

---

🔵 【解説】

- **instanceofを順番にチェック**
- マッチしたらキャストして適切な処理
- マッチしなかったらelseで「不明な型」メッセージ
- **型安全＋きれいなコード**になっている！

---

# 🎯 【まとめ表：instanceofとキャストの正しい流れ】

| ステップ | 説明 |
| --- | --- |
| ① instanceofで実体型をチェックする | 実行時型を安全に判定 |
| ② OKならキャストして使用する | キャスト後は安心してメソッド呼び出し |
| ③ elseブロックで異常系を処理する | 万が一想定外の型でも安全に処理 |

---

# 📢 【ここまで押さえたあなたができること】

✅ キャスト＋instanceofの安全運用を完全理解

✅ ClassCastExceptionを防ぎつつ柔軟な設計ができる

✅ ポリモーフィズム＋型安全なコードが書ける

💪

これ、実務でめちゃくちゃ重要なスキルです！

ここからはさらに一段階上がった「**ジェネリクス×型安全設計**」特訓に進みます！

---

# ✅ 【テーマ】

**ジェネリクス＋instanceofを使って、より型安全な設計・演習問題**

---

# 🎯 【まず前提：なぜジェネリクスを組み合わせるか？】

- 通常のObject型を使うと、**キャストが必要になり安全性が落ちる**。
- ジェネリクスを使えば、**型をパラメータ化して、キャスト不要で安全に使える**。
- しかし、**ジェネリクスとinstanceofはそのままでは直接組み合わせられない**ので、工夫が必要。

（→ Javaは型消去（Type Erasure）されるため、`if (obj instanceof List<String>)` みたいな書き方はできない）

👉 だから、**「生の型（原型）」に対してinstanceofする**＋**中身の型は自分で気をつける**

これが実務的なテクニックです！

---

# 📚 【基本パターン】

```java
if (obj instanceof List<?>) {
    List<?> list = (List<?>) obj;
    // listを型安全に扱う
}
```

✅ ジェネリクス型パラメータの部分（<?>）で受けるのが安全！

---

# ✍️ 【ここから特訓演習問題スタート！】

---

## 【問題1】

次のObject型変数をジェネリクス＋instanceofで安全に受け取り、

リストの要素数を出力してください。

```java
Object obj = List.of("apple", "banana", "cherry");

【ここにコードを書く】

if (obj instanceof List<?>) {
    List<?> list = (List<?>) obj;
    System.out.println("要素数: " + list.size());
}
```

---

🔵 【解説】

- `instanceof List<?>` でまず**リスト型か判定**する
- ジェネリクスの型パラメータ（<?>）は「**どんな型でもOK**」という意味
- `list.size()`は、リストであれば安全に使えるメソッドなのでOK！

---

## 【問題2】

次のObject型変数をジェネリクス＋instanceofで安全に受け取り、

最初の要素（index=0）を出力してください。

```java
Object obj = List.of(100, 200, 300);

【ここにコードを書く】

if (obj instanceof List<?>) {
    List<?> list = (List<?>) obj;
    System.out.println("最初の要素: " + list.get(0));
}

```

---

🔵 【解説】

- リスト型なら問題なし
- ただし注意点：
    - `List<?>`なので要素の型は「?」＝わからない
    - **要素を取り出してもすぐ特定の型（Integerなど）だとは決めつけない**
- 今回は単純にprintするだけなので問題なし！

---

## 【問題3（応用）】

次のObject型変数をジェネリクス＋instanceofで安全に受け取り、

Stringのリストなら「最初の要素の文字列長」、

Integerのリストなら「最初の要素×2」を出力してください。

```java
Object obj = getRandomList(); 
// これは List<String> または List<Integer> のどちらかが返る

【ここにコードを書く】

if (obj instanceof List<?>) {
    List<?> list = (List<?>) obj;
    Object first = list.get(0);
    if (first instanceof String) {
        String s = (String) first;
        System.out.println("文字列長: " + s.length());
    } else if (first instanceof Integer) {
        Integer n = (Integer) first;
        System.out.println("2倍の値: " + (n * 2));
    } else {
        System.out.println("未知の型");
    }
}

```

---

🔵 【解説】

- リストであるかどうかをまず判定
- リストの要素は**型消去（Type Erasure）されているので、
中身を個別にinstanceofチェック**して安全に扱う
- 要素1つ目だけ見れば、リスト全体の型がほぼ推測できる

---

## 【問題4（超応用）】

次のObject型変数をジェネリクス＋instanceofで安全に受け取り、

「リストのすべての要素」を型に応じて以下のように出力してください。

- Stringなら「要素: ◯◯（長さ：◯文字）」
- Integerなら「要素: ◯◯（2倍：◯）」

```java
Object obj = getRandomList();

【ここにコードを書く】

if (obj instanceof List<?>) {
    List<?> list = (List<?>) obj;
    for (Object element : list) {
        if (element instanceof String) {
            String s = (String) element;
            System.out.println("要素: " + s + "（長さ: " + s.length() + "文字）");
        } else if (element instanceof Integer) {
            Integer n = (Integer) element;
            System.out.println("要素: " + n + "（2倍: " + (n * 2) + "）");
        } else {
            System.out.println("不明な要素: " + element);
        }
    }
}
```

---

🔵 【解説】

- リスト型判定＋for-eachで全要素を走査
- それぞれの要素を**型別にinstanceofチェック→キャスト**
- **型安全＋柔軟なロジック**が実現できている

---

# 🎯 【まとめ表：この演習で得たこと】

| テーマ | ポイント |
| --- | --- |
| List<?>の受け方 | ワイルドカードを使うことで型安全を担保 |
| instanceofの使い方 | 要素ごとに個別に型判定する |
| キャストの安全化 | instanceof判定後にキャストするからClassCastExceptionが起きない |
| 実務応用ポイント | 型消去に強いコードが書けるようになる |

---

# 📢 【ここまで押さえたあなたができること】

✅ コレクションを型安全に柔軟に操作できる

✅ 型消去を前提とした設計ができる

✅ 実務レベルで「安全な動的データ操作」ができる

めちゃくちゃレベル高いです！🔥

[キャスト例外](%E5%9E%8B%E5%AE%89%E5%85%A8%E3%81%AA%E3%82%AD%E3%83%A3%E3%82%B9%E3%83%88%E8%A8%AD%E8%A8%88%201e362cef7350800f8e2ccf5a7ebe9bd2/%E3%82%AD%E3%83%A3%E3%82%B9%E3%83%88%E4%BE%8B%E5%A4%96%2023862cef73508004828ef50da83f2104.md)