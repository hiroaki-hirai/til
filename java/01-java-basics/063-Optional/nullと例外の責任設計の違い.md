# nullと例外の責任設計の違い

Q,

nullと例外の責任設計の違い（値 vs 状態 vs エラー）をお願いします。

Hiroakiさんのご要望は、非常に設計思想に根差した本質的な問いです。

**「null」と「例外」はどちらも「異常事態の表現」に使われることがありますが、実際には**

→ **「意味」も**

→ **「意図」も**

→ **「責任の所在」も異なります。**

以下、それらを **「責任設計（誰が何を処理すべきか）」の観点で整理**していきます。

---

## ✅ null と 例外の責任設計の違い

| 観点 | `null` | `例外 (Exception)` |
| --- | --- | --- |
| 表すもの | **「値が存在しない」＝状態の一種** | **「処理不能な事態」＝エラー** |
| 開発者の意図 | 値が未設定・未取得・空であることを表したい | 実行不能・契約違反・予期せぬ状況を通知したい |
| 発生箇所 | ロジックの自然な流れで発生 | 明示的に `throw` でスローされる |
| 想定されるか | **事前に想定される**（分岐対象として扱う） | **想定外であることが前提**（catch して対応） |
| 回復可能性 | 高い（代替値、空値などで処理継続） | 基本的に回復不可能（もしくは処理の巻き戻し） |
| 処理責任 | 呼び出し側（値をどう扱うか） | スロー側（何が例外なのか定義）＆ 呼び出し側（try-catchなどで対応） |
| 使用例 | 検索結果なし・設定未入力・非必須値 | ファイルが存在しない・DB接続失敗・契約違反（例：null禁止） |

---

## 🔍 具体例で比較

### 🔸 null を使うケース（状態の表現）

```java
String findUserName(int userId) {
    User user = db.find(userId);
    return (user != null) ? user.name : null;  // ← 存在しない場合は null
}
```

➡ **呼び出し側が、値があるかを確認して処理すべき責任を持つ**

---

### 🔸 例外を使うケース（契約違反の通知）

```java
String findUserName(int userId) {
    User user = db.find(userId);
    if (user == null) {
        throw new NoSuchElementException("User not found: " + userId); // ← 契約違反
    }
    return user.name;
}
```

➡ **スロー側が「これは異常事態」と定義し、呼び出し側が try-catch で対応すべき責任を持つ**

---

## 🎯 Optionalと例外の設計的住み分け

| 手段 | 意図 | 適用範囲 |
| --- | --- | --- |
| `Optional<T>` | 「**値があるかないかを、安全に分岐したい**」 | nullが許容される設計（例：検索結果、非必須項目） |
| `Exception` | 「**処理継続不可能な異常状態**を通知したい」 | 処理契約に違反した状態（例：null禁止、IO失敗） |

---

## ✅ 設計視点：責任の分配と明確化

### 1. **値の状態**は「呼び出し側の責任」

```java
Optional<User> user = repository.findUser(id);
```

- あるかないかを処理側で判断
- エラーではない（未登録などは状態の一種）

### 2. **例外**は「スロー側の責任 + 捕捉側の責任」

```java
try {
    User user = repository.getUserOrThrow(id);
} catch (NoSuchElementException e) {
    // ここで例外に対処
}
```

- ルール違反や想定外事態を定義
- 呼び出し側に明示的な対処を要求

---

## ✅ 統括：責任の観点からの比較

| 種別 | 説明 | 責任の所在 | Optionalでの扱い |
| --- | --- | --- | --- |
| null（値がない） | 状態の1つであり、処理の分岐対象 | 呼び出し側が分岐 | `Optional.empty()` で表現可能 |
| 例外（契約違反・不能） | 処理不能またはルール違反 | スロー側が定義し、呼び出し側が補足 | `Optional.orElseThrow()` で利用可能 |

---

## 🔚 最後に

Hiroakiさんのように、「nullと例外をどう使い分けるか」という設計的視点は、以下の設計指針に繋がります：

- **エラーを状態として扱うか（= null/Optional）**
- **それとも契約違反とみなすか（= Exception）**

---

もしさらに深く、DDD（ドメイン駆動設計）やエラーハンドリングパターン（Railway-oriented programmingなど）に興味があれば、そちらに繋げた解説も可能です。