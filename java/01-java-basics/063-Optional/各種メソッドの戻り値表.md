# 各種メソッドの戻り値表

# Q.

「Optionalの内部構造と使用メソッドの戻り値一覧表」をお願いします

承知しました、Hiroakiさん。

以下に、**Java SE 21 に準拠した `Optional<T>` の内部構造の整理**と、**代表的なメソッドの戻り値一覧表（`value` の有無での比較）**を用意しました。

---

## ✅ Optional<T> の内部構造（概念図）

```java
public final class Optional<T> {

    // 空の Optional（シングルトン）
    private static final Optional<?> EMPTY = new Optional<>(null);

    // 内部の値（null の可能性あり）
    private final T value;

    // コンストラクタ（private）
    private Optional(T value) {
        this.value = value;
    }

    // 値があるOptionalを生成（nullは禁止）
    public static <T> Optional<T> of(T value) {
        return new Optional<>(Objects.requireNonNull(value));
    }

    // 値があるかないかに応じて生成（null OK）
    public static <T> Optional<T> ofNullable(T value) {
        return value == null ? empty() : new Optional<>(value);
    }

    // 空の Optional を返す
    public static <T> Optional<T> empty() {
        @SuppressWarnings("unchecked")
        Optional<T> t = (Optional<T>) EMPTY;
        return t;
    }

    // 値を返す（nullなら例外）
    public T get() {
        if (value == null)
            throw new NoSuchElementException("No value present");
        return value;
    }

    // 省略…
}
```

---

## 📘 Optional 使用メソッドの戻り値一覧表

| メソッド | value == null のとき | value != null のとき |
| --- | --- | --- |
| `isPresent()` | `false` | `true` |
| `isEmpty()` | `true` | `false` |
| `get()` | `NoSuchElementException` を投げる | `value` を返す |
| `orElse(T other)` | `other` を返す | `value` を返す |
| `orElseGet(Supplier)` | Supplierの戻り値 | `value` を返す |
| `orElseThrow()` | `NoSuchElementException` を投げる | `value` を返す |
| `orElseThrow(Supplier)` | Supplier.get() が返す例外を投げる | `value` を返す |
| `ifPresent(Consumer)` | 何もしない | Consumer.accept(value) を実行 |
| `ifPresentOrElse(Consumer, Runnable)` | Runnable.run() を実行 | Consumer.accept(value) を実行 |
| `map(Function)` | `Optional.empty()` | `Optional.of(func.apply(value))` |
| `flatMap(Function)` | `Optional.empty()` | 関数の返す `Optional` を返す |
| `filter(Predicate)` | `Optional.empty()` | predicate.test(value) が true なら `Optional.of(value)`、false なら `Optional.empty()` |

---

## 🧠 よりイメージしやすく：動的フローの図式（簡略）

```java
Optional<T> o = Optional.ofNullable(value);

        ┌───── if value == null ─────┐
        ↓                            ↓
     EMPTY                     Optional.of(value)

メソッド使用時：
    get() → 例外 or 値
    orElse() → 代替値 or 値
    map() → 空のOptional or 加工されたOptional
    filter() → 条件通れば値付き、通らなければ空
```

---

## 💡 実用上の補足

- `get()` の使用はなるべく避け、`orElse()` や `ifPresent()` を使うのが推奨。
- `map()` は値があれば変換、なければ何もしない。
- `filter()` は条件を満たさなければ `Optional.empty()` に変化。

---

## 🔚 まとめ

- `Optional` の挙動は、内部の `value` が null か否かで一貫して変化します。
- 多くのメソッドは、「nullかもしれない」という不安を、**明示的な分岐メソッドで安全に扱える形に変える**ためのものです。
- まさに「**null の意図的で安全なラップ**」です。

---

さらにご希望があれば、Stream APIとの併用や、Optionalのアンチパターン（Optional<T>をフィールドや引数に使うべきでない理由）なども解説できます。お気軽にどうぞ。